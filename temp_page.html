<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BIAS-ATR æ™ºèƒ½ç½‘æ ¼äº¤æ˜“</title>
    <!-- å¼•å…¥ ECharts (æœ¬åœ°æ–‡ä»¶ï¼Œé¿å…CDNç½‘ç»œé—®é¢˜) -->
    <script src="/static/echarts.min.js?v=5.4.3"></script>
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: rgba(30, 41, 59, 0.7);
            --bg-card-hover: rgba(30, 41, 59, 0.9);
            --primary: #6366f1;
            --secondary: #8b5cf6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: rgba(148, 163, 184, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-dark);
            background-image:
                radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(139, 92, 246, 0.15) 0px, transparent 50%);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
        }

        /* ä¾§è¾¹å¯¼èˆª */
        .sidebar {
            width: 240px;
            background: rgba(15, 23, 42, 0.9);
            border-right: 1px solid var(--border);
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: fixed;
            height: 100vh;
            backdrop-filter: blur(10px);
            z-index: 100;
        }

        .logo {
            font-size: 20px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .nav-item {
            padding: 12px 16px;
            border-radius: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            font-weight: 500;
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            margin-left: 240px;
            padding: 32px;
            max-width: 1600px;
        }

        /* é¡¶éƒ¨çŠ¶æ€æ  */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .refresh-btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        /* ä»ªè¡¨ç›˜å¡ç‰‡ */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            backdrop-filter: blur(20px);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 13px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(to right, #fff, #cbd5e1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* ETF ç½‘æ ¼ */
        .etf-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 24px;
        }

        .etf-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s;
            backdrop-filter: blur(20px);
        }

        .etf-card:hover {
            background: var(--bg-card-hover);
            border-color: rgba(99, 102, 241, 0.3);
            transform: translateY(-4px);
        }

        .etf-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .etf-title h3 {
            font-size: 16px;
            font-weight: 700;
        }

        .etf-title span {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .etf-body {
            padding: 20px;
        }

        .etf-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .etf-stat-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .etf-stat-value {
            font-size: 18px;
            font-weight: 600;
        }

        .etf-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .action-btn {
            flex: 1;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        /* äº¤æ˜“æ—¥å¿—è¡¨æ ¼ */
        .trade-table {
            width: 100%;
            border-collapse: collapse;
        }

        .trade-table th {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid var(--border);
            color: var(--text-secondary);
            font-weight: 600;
        }

        .trade-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        .trade-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--primary);
        }

        .action-btn.primary {
            background: var(--primary);
            border-color: var(--primary);
        }

        .action-btn.primary:hover {
            background: #5855f0;
        }

        /* çŠ¶æ€æ ‡ç­¾ */
        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge.deep {
            background: rgba(16, 185, 129, 0.15);
            color: #34d399;
        }

        .badge.gold {
            background: rgba(245, 158, 11, 0.15);
            color: #fbbf24;
        }

        .badge.osc {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
        }

        .badge.reduce {
            background: rgba(249, 115, 22, 0.15);
            color: #fb923c;
        }

        .badge.escape {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
        }

        /* æ¨¡æ€æ¡† */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background: #1e293b;
            border-radius: 24px;
            width: 90%;
            max-width: 1000px;
            border: 1px solid var(--border);
            position: relative;
            transform: scale(0.95);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
        }

        #klineChart {
            width: 100%;
            height: 500px;
            padding: 20px;
        }

        /* æé†’æ¨ªå¹… */
        .alert-banner {
            background: linear-gradient(135deg, var(--warning), #f97316);
            border-radius: 12px;
            padding: 16px 24px;
            margin-bottom: 24px;
            display: none;
            align-items: center;
            gap: 16px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-10px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* é¢œè‰²è¾…åŠ© */
        .text-up {
            color: var(--danger);
        }

        .text-down {
            color: var(--success);
        }

        .bg-up {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .bg-down {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        /* äº¤æ˜“å¼¹çª— */
        .trade-form {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 13px;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-size: 16px;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn-submit {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }

        .btn-buy {
            background: var(--success);
            color: white;
        }

        .btn-sell {
            background: var(--danger);
            color: white;
        }

        /* é€šçŸ¥ Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 16px 24px;
            background: #1e293b;
            border: 1px solid var(--border);
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 2000;
            transform: translateX(200%);
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .toast.show {
            transform: translateX(0);
        }

        /* ç§»åŠ¨ç«¯å“åº”å¼é€‚é… */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                position: fixed;
                bottom: 0;
                left: 0;
                top: auto;
                flex-direction: row;
                border-right: none;
                border-top: 1px solid var(--border);
                justify-content: space-around;
                align-items: center;
                padding: 8px;
                z-index: 1000;
                background: rgba(15, 23, 42, 0.98);
                /* æ›´ä¸é€æ˜çš„èƒŒæ™¯ */
            }

            .logo {
                display: none;
            }

            .nav-menu {
                flex-direction: row;
                width: 100%;
                justify-content: space-around;
            }

            .nav-item {
                flex-direction: column;
                font-size: 11px;
                padding: 6px;
                gap: 4px;
                border-radius: 8px;
                white-space: nowrap;
            }

            /* éšè—ä¾§è¾¹æ åº•éƒ¨çš„ç³»ç»ŸçŠ¶æ€ï¼Œé¿å…å ç”¨åº•éƒ¨å¯¼èˆªç©ºé—´ */
            .sidebar>div:last-child {
                display: none;
            }

            .main-content {
                margin-left: 0;
                margin-bottom: 70px;
                /* ä¸ºåº•éƒ¨å¯¼èˆªç•™å‡ºç©ºé—´ */
                padding: 16px;
                width: 100%;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
                margin-bottom: 20px;
            }

            .header>div {
                width: 100%;
            }

            .refresh-btn {
                width: 100%;
                justify-content: center;
            }

            .dashboard-grid {
                grid-template-columns: 1fr 1fr;
                /* ç§»åŠ¨ç«¯ä¸€è¡Œæ˜¾ç¤ºä¸¤ä¸ªå¡ç‰‡ */
                gap: 12px;
                margin-bottom: 20px;
            }

            .stat-card {
                padding: 16px;
            }

            .stat-value {
                font-size: 20px;
            }

            .etf-grid {
                grid-template-columns: 1fr;
                /* ç§»åŠ¨ç«¯ ETF å¡ç‰‡å•åˆ—æ˜¾ç¤º */
            }

            .etf-actions {
                flex-wrap: wrap;
            }

            .toast {
                bottom: 80px;
                /* é¿å…é®æŒ¡åº•éƒ¨å¯¼èˆª */
                right: 20px;
                left: 20px;
                width: auto;
                justify-content: center;
            }
        }
    </style>
</head>

<body>
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar">
        <div class="logo">
            ğŸ¤– BIAS-ATR PRO
        </div>
        <div class="nav-menu">
            <div class="nav-item active" onclick="showPage('overview')">ğŸ“Š æ¦‚è§ˆç›‘æ§</div>
            <div class="nav-item" onclick="showPage('tradeLog')">ğŸ“ äº¤æ˜“æ—¥å¿—</div>
            <div class="nav-item" onclick="showPage('alertHistory')">ğŸ”” æé†’å†å²</div>
            <div class="nav-item" onclick="alert('åŠŸèƒ½å¼€å‘ä¸­...')">âš™ï¸ ç³»ç»Ÿè®¾ç½®</div>
        </div>

        <div style="margin-top: auto; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 12px;">
            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">ç³»ç»ŸçŠ¶æ€</div>
            <div style="display: flex; justify-content: space-between; font-size: 13px;">
                <span>ğŸ”Œ äº¤æ˜“æ¥å£</span>
                <span id="traderStatus">æ£€æŸ¥ä¸­...</span>
            </div>
        </div>
    </div>

    <!-- ä¸»å†…å®¹ -->
    <div class="main-content">
        <!-- æ¦‚è§ˆé¡µé¢ -->
        <div id="overview-page">
            <!-- å¤´éƒ¨ -->
            <div class="header">
                <div>
                    <h1 style="font-size: 24px; font-weight: 700; margin-bottom: 4px;">å¸‚åœºæ¦‚è§ˆ</h1>
                    <div style="color: var(--text-secondary); font-size: 14px;">
                        æ•°æ®æº: <span id="dataSource" style="color: var(--primary)">--</span>
                        | æ›´æ–°: <span id="lastUpdate">--</span>
                    </div>
                </div>
                <button class="refresh-btn" onclick="refresh()">
                    ğŸ”„ åˆ·æ–°æ•°æ®
                </button>
            </div>

            <!-- æé†’æ¨ªå¹… -->
            <div class="alert-banner" id="tradeBanner">
                <div style="font-size: 24px;">ğŸ””</div>
                <div>
                    <div style="font-weight: 700; font-size: 16px;">ä»·æ ¼è§¦å‘ç½‘æ ¼æé†’</div>
                    <div style="font-size: 14px; opacity: 0.9;" id="bannerText">--</div>
                </div>
            </div>

            <!-- æ ¸å¿ƒæŒ‡æ ‡å¡ç‰‡ -->
            <div class="dashboard-grid">
                <div class="stat-card">
                    <div class="stat-label">æ€»èµ„äº§</div>
                    <div class="stat-value" id="totalCapital">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æ€»ç›ˆäº</div>
                    <div class="stat-value" id="totalProfit">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æŒä»“å¸‚å€¼</div>
                    <div class="stat-value" id="totalValue">--</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ä»“ä½æ¯”ä¾‹</div>
                    <div class="stat-value" id="positionPct">--</div>
                </div>
            </div>

            <!-- ETF ç½‘æ ¼è§†å›¾ -->
            <div class="etf-grid" id="etfGrid">
                <!-- åŠ¨æ€ç”Ÿæˆçš„å†…å®¹ -->
                <div style="color: var(--text-secondary); grid-column: 1/-1; text-align: center; padding: 40px;">
                    åŠ è½½ä¸­...
                </div>
            </div>
        </div>

        <!-- äº¤æ˜“æ—¥å¿—é¡µé¢ -->
        <div id="trade-log-page" style="display: none;">
            <div class="header">
                <div>
                    <h1 style="font-size: 24px; font-weight: 700; margin-bottom: 4px;">äº¤æ˜“æ—¥å¿—</h1>
                    <div style="color: var(--text-secondary); font-size: 14px;">
                        å®æ—¶äº¤æ˜“è®°å½•
                    </div>
                </div>
                <button class="refresh-btn" onclick="loadTradeHistory()">
                    ğŸ”„ åˆ·æ–°
                </button>
            </div>

            <div class="trade-log-container">
                <div id="tradeLogContent"
                    style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 20px;">
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>

        <!-- æé†’å†å²é¡µé¢ -->
        <div id="alert-history-page" style="display: none;">
            <div class="header">
                <div>
                    <h1 style="font-size: 24px; font-weight: 700; margin-bottom: 4px;">æé†’å†å²</h1>
                    <div style="color: var(--text-secondary); font-size: 14px;">
                        ä»·æ ¼æé†’è®°å½•
                    </div>
                </div>
                <button class="refresh-btn" onclick="loadAlertHistory()">
                    ğŸ”„ åˆ·æ–°
                </button>
            </div>

            <div class="trade-log-container">
                <div id="alertHistoryContent"
                    style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 20px;">
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- å›¾è¡¨æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="chartModal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2 id="chartTitle" style="font-size: 20px;">--</h2>
                    <span id="chartSubtitle" style="color: var(--text-secondary); font-size: 14px;">--</span>
                </div>
                <button class="close-btn" onclick="closeModal('chartModal')">&times;</button>
            </div>
            <div id="klineChart"></div>
        </div>
    </div>

    <!-- äº¤æ˜“æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="tradeModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>å¿«é€Ÿäº¤æ˜“</h2>
                <button class="close-btn" onclick="closeModal('tradeModal')">&times;</button>
            </div>
            <div class="trade-form">
                <div class="form-group">
                    <label class="form-label">ETF åç§°</label>
                    <input type="text" id="tradeName" class="form-control" readonly style="opacity: 0.5">
                    <input type="hidden" id="tradeCode">
                </div>
                <div class="form-group">
                    <label class="form-label">äº¤æ˜“æ–¹å‘</label>
                    <select id="tradeDir" class="form-control">
                        <option value="BUY">ğŸŸ¢ ä¹°å…¥</option>
                        <option value="SELL">ğŸ”´ å–å‡º</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ä»·æ ¼</label>
                    <input type="number" id="tradePrice" class="form-control" step="0.001">
                </div>
                <div class="form-group">
                    <label class="form-label">æ•°é‡</label>
                    <input type="number" id="tradeVol" class="form-control" step="100">
                </div>
                <div class="form-group">
                    <label class="form-label">é¢„ä¼°é‡‘é¢: <span id="tradeAmount"
                            style="color: var(--primary)">Â¥0</span></label>
                </div>
                <button class="btn-submit" id="tradeSubmitBtn" onclick="submitTrade()">ç¡®è®¤ä¸‹å•</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <span id="toastIcon">âœ…</span>
        <span id="toastMsg">æ“ä½œæˆåŠŸ</span>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€
        let myChart = null;
        let etfDataMap = {};

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initChart();
            loadData();
            setInterval(loadData, 3000); // 3ç§’åˆ·æ–°
        });

        // é¡µé¢åˆ‡æ¢åŠŸèƒ½
        function showPage(pageName) {
            // éšè—æ‰€æœ‰é¡µé¢
            document.getElementById('overview-page').style.display = 'none';
            document.getElementById('trade-log-page').style.display = 'none';
            document.getElementById('alert-history-page').style.display = 'none';

            // ç§»é™¤æ‰€æœ‰å¯¼èˆªé¡¹çš„æ´»åŠ¨çŠ¶æ€
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));

            // æ˜¾ç¤ºé€‰å®šçš„é¡µé¢å¹¶æ¿€æ´»å¯¹åº”çš„å¯¼èˆªé¡¹
            if (pageName === 'overview') {
                document.getElementById('overview-page').style.display = 'block';
                document.querySelector('.nav-item:nth-child(1)').classList.add('active');
            } else if (pageName === 'tradeLog') {
                document.getElementById('trade-log-page').style.display = 'block';
                document.querySelector('.nav-item:nth-child(2)').classList.add('active');
                loadTradeHistory(); // åŠ è½½äº¤æ˜“å†å²
            } else if (pageName === 'alertHistory') {
                document.getElementById('alert-history-page').style.display = 'block';
                document.querySelector('.nav-item:nth-child(3)').classList.add('active');
                loadAlertHistory(); // åŠ è½½æé†’å†å²
            }
        }

        // åŠ è½½äº¤æ˜“å†å²
        async function loadTradeHistory() {
            try {
                const res = await fetch('/api/trade_history?limit=100');
                const data = await res.json();

                const container = document.getElementById('tradeLogContent');
                if (data.success) {
                    if (data.trades && data.trades.length > 0) {
                        container.innerHTML = `
                            <div style="overflow-x: auto;">
                                <table class="trade-table">
                                    <thead>
                                        <tr>
                                            <th>æ—¶é—´</th>
                                            <th>ä»£ç </th>
                                            <th>æ–¹å‘</th>
                                            <th>ä»·æ ¼</th>
                                            <th>æ•°é‡</th>
                                            <th>ç›ˆäº</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.trades.map(trade => `
                                            <tr>
                                                <td>${trade.timestamp ? trade.timestamp.substring(0, 19).replace('T', ' ') : '--'}</td>
                                                <td>${trade.code || '--'}</td>
                                                <td>${trade.direction === 'BUY' ? 'ğŸŸ¢ ä¹°å…¥' : (trade.direction === 'SELL' ? 'ğŸ”´ å–å‡º' : trade.direction)}</td>
                                                <td>${trade.price ? trade.price.toFixed(3) : '--'}</td>
                                                <td>${trade.volume || '--'}</td>
                                                <td>${trade.realized_pnl !== null && trade.realized_pnl !== undefined ?
                                (trade.realized_pnl >= 0 ? '+' : '') + trade.realized_pnl.toFixed(2) : '--'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    } else {
                        container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">æš‚æ— äº¤æ˜“è®°å½•</div>';
                    }
                } else {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--danger);">åŠ è½½å¤±è´¥: ' + data.message + '</div>';
                }
            } catch (err) {
                console.error('åŠ è½½äº¤æ˜“å†å²å¤±è´¥:', err);
                document.getElementById('tradeLogContent').innerHTML = '<div style="text-align: center; padding: 40px; color: var(--danger);">åŠ è½½å¤±è´¥: ' + err.message + '</div>';
            }
        }

        // åŠ è½½æé†’å†å²
        async function loadAlertHistory() {
            try {
                const res = await fetch('/api/alerts?hours=168'); // è·å–æœ€è¿‘7å¤©çš„æé†’
                const data = await res.json();

                const container = document.getElementById('alertHistoryContent');
                if (data.success !== false) { // alerts API doesn't follow the same pattern
                    if (data.alerts && data.alerts.length > 0) {
                        // æŒ‰æ—¶é—´å€’åºæ’åˆ—ï¼Œæœ€æ–°çš„åœ¨æœ€ä¸Šé¢
                        const sortedAlerts = data.alerts.sort((a, b) => {
                            return new Date(b.timestamp) - new Date(a.timestamp);
                        });

                        container.innerHTML = `
                            <div style="overflow-x: auto;">
                                <table class="trade-table">
                                    <thead>
                                        <tr>
                                            <th>æ—¶é—´</th>
                                            <th>ä»£ç </th>
                                            <th>ç±»å‹</th>
                                            <th>å½“å‰ä»·æ ¼</th>
                                            <th>ç›®æ ‡ä»·æ ¼</th>
                                            <th>æ•°é‡</th>
                                            <th>æ¶ˆæ¯</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${sortedAlerts.map(alert => `
                                            <tr>
                                                <td>${new Date(alert.timestamp).toLocaleString('zh-CN')}</td>
                                                <td>${alert.code}</td>
                                                <td>${alert.alert_type === 'BUY_TOUCH' ? 'ğŸŸ¢ ä¹°å…¥æé†’' : 'ğŸ”´ å–å‡ºæé†’'}</td>
                                                <td>${alert.price ? alert.price.toFixed(3) : '--'}</td>
                                                <td>${alert.target_price ? alert.target_price.toFixed(3) : '--'}</td>
                                                <td>${alert.amount || '--'}</td>
                                                <td>${alert.message}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    } else {
                        container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">æš‚æ— æé†’è®°å½•</div>';
                    }
                } else {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--danger);">åŠ è½½å¤±è´¥: ' + data.message + '</div>';
                }
            } catch (err) {
                console.error('åŠ è½½æé†’å†å²å¤±è´¥:', err);
                document.getElementById('alertHistoryContent').innerHTML = '<div style="text-align: center; padding: 40px; color: var(--danger);">åŠ è½½å¤±è´¥: ' + err.message + '</div>';
            }
        }

        // åˆå§‹åŒ–å›¾è¡¨å®ä¾‹
        function initChart() {
            myChart = echarts.init(document.getElementById('klineChart'));
            window.addEventListener('resize', () => myChart.resize());
        }

        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();

                updateHeader(data);
                updateCards(data.summary);
                renderEtfGrid(data.etf_list);
                updateAlerts(data.alerts);
                updateTraderStatus();

                // ä¿å­˜æ•°æ®ä¾›å…¶ä»–å‡½æ•°ä½¿ç”¨
                data.etf_list.forEach(etf => {
                    etfDataMap[etf.code] = etf;
                });

            } catch (err) {
                console.error('åŠ è½½å¤±è´¥', err);
            }
        }

        // æ›´æ–°å¤´éƒ¨
        function updateHeader(data) {
            document.getElementById('dataSource').textContent = data.data_source;
            document.getElementById('lastUpdate').textContent = data.timestamp;
        }

        // æ›´æ–°äº¤æ˜“æ¥å£çŠ¶æ€
        async function updateTraderStatus() {
            try {
                const res = await fetch('/api/trader/status');
                const status = await res.json();
                const el = document.getElementById('traderStatus');
                if (status.connected) {
                    el.innerHTML = '<span style="color:var(--success)">â— å·²è¿æ¥</span>';
                } else if (!status.has_trader) {
                    el.innerHTML = '<span style="color:var(--warning)">â— æœªå®‰è£…</span>';
                } else {
                    el.innerHTML = '<span style="color:var(--danger)">â— æ–­å¼€</span>';
                }
            } catch (e) { }
        }

        // æ›´æ–°æ ¸å¿ƒæŒ‡æ ‡
        function updateCards(s) {
            document.getElementById('totalCapital').textContent = 'Â¥' + Math.round(s.total_capital).toLocaleString();
            document.getElementById('totalValue').textContent = 'Â¥' + Math.round(s.total_value).toLocaleString();

            const profitEl = document.getElementById('totalProfit');
            const sign = s.total_profit >= 0 ? '+' : '';
            profitEl.textContent = sign + 'Â¥' + Math.round(s.total_profit).toLocaleString();
            profitEl.style.color = s.total_profit >= 0 ? 'var(--success)' : 'var(--danger)';

            document.getElementById('positionPct').textContent = s.position_pct.toFixed(1) + '%';
        }

        // æ¸²æŸ“ ETF ç½‘æ ¼
        function renderEtfGrid(list) {
            const container = document.getElementById('etfGrid');

            // å¦‚æœå·²ç»åœ¨æ‹–åŠ¨æˆ–äº¤äº’ï¼Œæš‚æ—¶ä¸æ›´æ–°DOMé˜²æ­¢é—ªçƒï¼ˆå¯ä¼˜åŒ–ç‚¹ï¼‰

            container.innerHTML = list.map(etf => {
                const biasClass = etf.bias >= 0 ? 'text-up' : 'text-down';
                const pnl = (etf.price - etf.holdings.avg_cost) * etf.holdings.volume;
                const pnlClass = pnl >= 0 ? 'text-up' : 'text-down';

                // è®¢å•æ ‡ç­¾
                const orderTags = etf.orders.slice(0, 3).map(o =>
                    `<span class="badge ${o.direction === 'BUY' ? 'bg-down' : 'bg-up'}">${o.direction === 'BUY' ? 'ä¹°' : 'å–'} ${o.price.toFixed(3)}</span>`
                ).join('');

                return `
                <div class="etf-card">
                    <div class="etf-header">
                        <div class="etf-title">
                            <h3>${etf.name}</h3>
                            <span>${etf.code}</span>
                        </div>
                        <div style="text-align: right">
                            <div style="font-size: 20px; font-weight: 700;">${etf.price.toFixed(3)}</div>
                            <div class="${biasClass}" style="font-size: 13px;">BIAS: ${etf.bias.toFixed(2)}%</div>
                        </div>
                    </div>
                    <div class="etf-body">
                        <div class="etf-stats">
                            <div class="etf-stat-item">
                                <span style="font-size:12px; color:var(--text-secondary)">æŒä»“</span>
                                <span class="etf-stat-value">${etf.holdings.volume.toLocaleString()}</span>
                            </div>
                            <div class="etf-stat-item">
                                <span style="font-size:12px; color:var(--text-secondary)">ç›ˆäº</span>
                                <span class="etf-stat-value ${pnlClass}">${pnl > 0 ? '+' : ''}${Math.round(pnl)}</span>
                            </div>
                            <div class="etf-stat-item">
                                <span style="font-size:12px; color:var(--text-secondary)">çŠ¶æ€</span>
                                <div>${getStatusBadge(etf.status)}</div>
                            </div>
                            <div class="etf-stat-item">
                                <span style="font-size:12px; color:var(--text-secondary)">ç›®æ ‡</span>
                                <div>${etf.target_pos.toFixed(0)}%</div>
                             </div>
                             <div class="etf-stat-item">
                                <span style="font-size:12px; color:var(--text-secondary)">æˆæœ¬</span>
                                <div>${etf.holdings.avg_cost.toFixed(3)}</div>
                            </div>
                        </div>

                        <div style="margin-bottom: 12px; display: flex; gap: 4px; flex-wrap: wrap;">
                            ${orderTags || '<span style="font-size:12px; color:var(--text-secondary)">æš‚æ— æ“ä½œå»ºè®®</span>'}
                        </div>

                        <!-- [NEW] æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯ -->
                        ${etf.warnings && etf.warnings.length > 0 ?
                        `<div style="margin-bottom: 12px; padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; font-size: 12px; color: var(--danger);">
                                ${etf.warnings.map(w => `<div>âš ï¸ ${w}</div>`).join('')}
                            </div>`
                        : ''
                    }

                        <div class="etf-actions">
                            <button class="action-btn primary" onclick="showChart('" + etf.code + "')">ğŸ“ˆ Kçº¿åˆ†æ</button>
                            <button class="action-btn" onclick="openTrade('" + etf.code + "', 'BUY')">ä¹°å…¥</button>
                            <button class="action-btn" onclick="openTrade('" + etf.code + "', 'SELL')">å–å‡º</button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function getStatusBadge(status) {
            if (status.includes('DEEP')) return '<span class="badge deep">ğŸŸ¢ æ·±å‘æœºä¼š</span>';
            if (status.includes('GOLD')) return '<span class="badge gold">ğŸŸ¡ é»„é‡‘åŒºé—´</span>';
            if (status.includes('OSCILLATION')) return '<span class="badge osc">ğŸ”µ éœ‡è¡æŒæœ‰</span>';
            if (status.includes('REDUCE')) return '<span class="badge reduce">ğŸŸ  å‡æŒåŒºé—´</span>';
            return '<span class="badge escape">ğŸ”´ é€ƒé¡¶åŒºåŸŸ</span>';
        }

        function updateAlerts(alerts) {
            const banner = document.getElementById('tradeBanner');
            if (alerts.new_count > 0) {
                banner.style.display = 'flex';
                document.getElementById('bannerText').textContent =
                    `${alerts.new_count} ä¸ªæœ€æ–°äº¤æ˜“ä¿¡å·å¾…å¤„ç†`;
            } else {
                banner.style.display = 'none';
            }
        }

        // æ˜¾ç¤ºå›¾è¡¨
        async function showChart(code) {
            const modal = document.getElementById('chartModal');
            modal.classList.add('active');

            // [FIX] ç­‰å¾…æ¨¡æ€æ¡†æ˜¾ç¤ºåŠ¨ç”»å®Œæˆåé‡ç½®å›¾è¡¨å°ºå¯¸
            setTimeout(() => {
                if (myChart) myChart.resize();
            }, 100);

            const etf = etfDataMap[code];
            document.getElementById('chartTitle').textContent = `${etf.name} (${code})`;
            document.getElementById('chartSubtitle').textContent = `BIAS: ${etf.bias.toFixed(2)}% | çŠ¶æ€: ${etf.status}`;

            myChart.showLoading();

            try {
                // è·å–Kçº¿æ•°æ®
                const res = await fetch(`/api/kline/${code}?count=100`);
                const json = await res.json();

                if (!json.success) throw new Error(json.message);

                const data = json.data;
                const dates = data.map(i => i.date);
                const klineData = data.map(i => [i.open, i.close, i.low, i.high]);
                const biasData = data.map(i => i.bias);
                const ma20Data = data.map(i => i.ma20);

                const gridInfo = json.grid || { orders: [], active_pairs: [] };

                // æ„å»ºæ ‡çº¿æ•°æ®
                const markLineData = [];

                // 1. å»ºè®®è®¢å• (å®çº¿/ç²—)
                gridInfo.orders.forEach(o => {
                    const color = o.direction === 'BUY' ? '#10b981' : '#ef4444';
                    markLineData.push({
                        yAxis: o.price,
                        label: {
                            formatter: `${o.direction === 'BUY' ? 'ä¹°' : 'å–'}: ${o.price.toFixed(3)}`,
                            color: color,
                            position: 'end'
                        },
                        lineStyle: { color: color, type: 'solid', width: 2 }
                    });
                });

                // 2. æŒä»“é…å¯¹ (è™šçº¿/ç»†)
                gridInfo.active_pairs.forEach(p => {
                    // ç›®æ ‡å–å‡ºçº¿
                    markLineData.push({
                        yAxis: p.target_sell_price,
                        label: {
                            formatter: `ğŸ¯ç›®æ ‡: ${p.target_sell_price.toFixed(3)}`,
                            color: '#fbbf24',
                            position: 'start',
                            fontSize: 10
                        },
                        lineStyle: { color: '#fbbf24', type: 'dashed', width: 1, opacity: 0.6 }
                    });
                    // ä¹°å…¥æˆæœ¬çº¿
                    markLineData.push({
                        yAxis: p.buy_price,
                        label: {
                            formatter: `ğŸ”’æŒä»“: ${p.buy_price.toFixed(3)}`,
                            color: '#94a3b8',
                            position: 'start',
                            fontSize: 10
                        },
                        lineStyle: { color: '#94a3b8', type: 'dotted', width: 1, opacity: 0.4 }
                    });
                });

                const option = {
                    backgroundColor: 'transparent',
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: { type: 'cross' }
                    },
                    grid: [
                        { left: '5%', right: '5%', height: '50%' },
                        { left: '5%', right: '5%', top: '65%', height: '25%' }
                    ],
                    xAxis: [
                        { type: 'category', data: dates, scale: true },
                        { type: 'category', gridIndex: 1, data: dates, show: false }
                    ],
                    yAxis: [
                        { scale: true, splitLine: { show: false }, axisLabel: { color: '#94a3b8' } },
                        { scale: true, gridIndex: 1, splitLine: { show: false }, axisLabel: { color: '#94a3b8' } }
                    ],
                    series: [
                        {
                            type: 'candlestick',
                            data: klineData,
                            itemStyle: {
                                color: '#ef4444',
                                color0: '#10b981',
                                borderColor: '#ef4444',
                                borderColor0: '#10b981'
                            },
                            markLine: {
                                symbol: ['none', 'none'],
                                data: markLineData,
                                silent: true
                            }
                        },
                        {
                            name: 'MA20',
                            type: 'line',
                            data: ma20Data,
                            smooth: true,
                            lineStyle: { opacity: 0.5 }
                        },
                        {
                            name: 'BIAS',
                            type: 'line',
                            xAxisIndex: 1,
                            yAxisIndex: 1,
                            data: biasData,
                            itemStyle: { color: '#6366f1' },
                            areaStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    { offset: 0, color: 'rgba(99, 102, 241, 0.5)' },
                                    { offset: 1, color: 'rgba(99, 102, 241, 0.0)' }
                                ])
                            }
                        }
                    ]
                };

                myChart.setOption(option);
            } catch (err) {
                alert('åŠ è½½å›¾è¡¨å¤±è´¥: ' + err.message);
            } finally {
                myChart.hideLoading();
            }
        }

        // äº¤æ˜“åŠŸèƒ½
        function openTrade(code, dir) {
            const etf = etfDataMap[code];
            document.getElementById('tradeCode').value = code;
            document.getElementById('tradeName').value = etf.name;
            document.getElementById('tradeDir').value = dir;

            // æŸ¥æ‰¾å»ºè®®ä»·æ ¼
            const suggestOrder = etf.orders.find(o => o.direction === dir);
            document.getElementById('tradePrice').value = suggestOrder ? suggestOrder.price : etf.price;
            document.getElementById('tradeVol').value = suggestOrder ? suggestOrder.amount : 100;

            updateTradeUI();
            document.getElementById('tradeModal').classList.add('active');
        }

        function updateTradeUI() {
            const p = parseFloat(document.getElementById('tradePrice').value) || 0;
            const v = parseFloat(document.getElementById('tradeVol').value) || 0;
            document.getElementById('tradeAmount').textContent = 'Â¥' + (p * v).toFixed(2);

            const dir = document.getElementById('tradeDir').value;
            const btn = document.getElementById('tradeSubmitBtn');
            btn.className = `btn-submit ${dir === 'BUY' ? 'btn-buy' : 'btn-sell'}`;
            btn.textContent = dir === 'BUY' ? 'ç¡®è®¤ä¹°å…¥' : 'ç¡®è®¤å–å‡º';
        }

        // ç›‘å¬è¾“å…¥å˜åŒ–
        document.getElementById('tradePrice').addEventListener('input', updateTradeUI);
        document.getElementById('tradeVol').addEventListener('input', updateTradeUI);
        document.getElementById('tradeDir').addEventListener('change', updateTradeUI);

        async function submitTrade() {
            const btn = document.getElementById('tradeSubmitBtn');
            btn.disabled = true;
            btn.textContent = 'æäº¤ä¸­...';

            try {
                const res = await fetch('/api/trade', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        code: document.getElementById('tradeCode').value,
                        direction: document.getElementById('tradeDir').value,
                        price: parseFloat(document.getElementById('tradePrice').value),
                        volume: parseInt(document.getElementById('tradeVol').value)
                    })
                });
                const json = await res.json();

                if (json.success) {
                    showToast('ä¸‹å•æˆåŠŸï¼', 'success');
                    closeModal('tradeModal');
                    refresh();
                } else {
                    showToast('å¤±è´¥: ' + json.message, 'error');
                }
            } catch (err) {
                showToast('ç½‘ç»œé”™è¯¯');
            } finally {
                btn.disabled = false;
            }
        }

        // è¾…åŠ©åŠŸèƒ½
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function refresh() {
            fetch('/api/refresh').then(loadData);
        }

        function showToast(msg, type = 'success') {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').textContent = msg;
            document.getElementById('toastIcon').textContent = type === 'success' ? 'âœ…' : 'âŒ';
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
    </script>
</body>

</html>